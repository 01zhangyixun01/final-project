<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢ºèªè³¼è²· - è¶…ç´šå¸‚å ´</title>
    <style>
        /* åŸºç¤æ¨£å¼é‡è¨­ */
        * { box-sizing: border-box; }
        body {
            background: #f4f7f6;
            margin: 0;
            font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif;
            color: #333;
        }

        /* å°è¦½åˆ— */
        .navbar {
            background-color: #2c3e50;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .logo { font-weight: bold; color: #fff; text-decoration: none; font-size: 1.2rem; }
        .navlink { color: #bdc3c7; text-decoration: none; font-size: 0.9rem; }

        /* è³¼è²·å®¹å™¨ */
        .buy-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            display: flex;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            gap: 30px;
        }

        /* å·¦å´åœ–ç‰‡ */
        .product-image-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .img_box {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 10px;
        }

        /* å³å´è³‡è¨Š */
        .product-info-section {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .name_box { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .text { color: #7f8c8d; line-height: 1.6; margin-bottom: 20px; }
        .cost_box { font-size: 1.5rem; color: #e74c3c; font-weight: bold; margin-bottom: 25px; }

        /* è³¼è²·æ§åˆ¶å€ */
        .order-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .control-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        label { font-weight: bold; color: #34495e; }

        /* æ•¸é‡è¼¸å…¥æ¡†ç¾åŒ– */
        input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 1rem;
        }

        .total-price-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            border-top: 1px solid #ddd;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.3s;
        }
        .btn:hover { background: #27ae60; transform: translateY(-2px); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* RWD éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .buy-container {
                flex-direction: column;
                margin: 20px;
                padding: 15px;
            }
            .product-image-section { margin-bottom: 20px; }
            .name_box { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <a href="./home" class="logo">SUPERMARKET</a>
        <a href="./home" class="navlink">å–æ¶ˆè³¼è²·ä¸¦è¿”å›</a>
    </div>

    <div class="main">
        <p style="text-align: center; margin-top: 50px;" id="loadingText">å•†å“è³‡è¨Šè¼‰å…¥ä¸­...</p>
    </div>

    <script>
        const main = document.querySelector('.main');
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        let token = sessionStorage.getItem('token');
        let productPrice = 0; // ç”¨æ–¼è¨ˆç®—ç¸½åƒ¹

        if (!token || !productId) {
            window.location.replace('/');
        }

        const headers = {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "Authorization": `Bearer ${token}`,
        }

        // å–å¾—å•†å“è©³æƒ…
        fetch('http://127.0.0.1:8000/getProducts', {
            method: "GET",
            headers: headers
        })
        .then(response => response.json())
        .then(response => {
            const product = response.data.find(thing => thing.id == productId);
            
            if (product) {
                productPrice = product.price;
                document.getElementById('loadingText').style.display = 'none';
                
                main.innerHTML = `
                    <div class="buy-container">
                        <div class="product-image-section">
                            <img class="img_box" src="${product.image_url}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/400x300?text=ç„¡å•†å“åœ–ç‰‡'">
                        </div>
                        <div class="product-info-section">
                            <div class="name_box">${product.name}</div>
                            <div class="text">${product.description || 'æš«ç„¡å•†å“æè¿°ã€‚'}</div>
                            <div class="cost_box">å–®åƒ¹ï¼š$${product.price}</div>
                            
                            <div class="order-controls">
                                <div class="control-group">
                                    <label for="buyCount">è³¼è²·æ•¸é‡</label>
                                    <input type="number" id="buyCount" value="1" min="1" oninput="updateTotal()">
                                </div>
                                <div class="total-price-display">
                                    <span>æ‡‰ä»˜ç¸½é¡</span>
                                    <span id="totalAmount">$${product.price}</span>
                                </div>
                                <button class="btn" id="submitBtn">ç¢ºèªè³¼è²·</button>
                            </div>
                        </div>
                    </div>`;

                bindEvents();
            } else {
                main.innerHTML = '<p style="text-align:center;">æ‰¾ä¸åˆ°è©²å•†å“</p>';
            }
        })
        .catch(error => {
            console.error(error);
            main.innerHTML = '<p style="text-align:center;">é€£ç·šéŒ¯èª¤</p>';
        });

        // å‹•æ…‹æ›´æ–°ç¸½åƒ¹
        function updateTotal() {
            const count = document.querySelector("#buyCount").value;
            const totalAmount = document.querySelector("#totalAmount");
            if (count > 0) {
                totalAmount.innerText = `$${count * productPrice}`;
            }
        }

        function bindEvents() {
            const btn = document.querySelector("#submitBtn");
            btn.addEventListener('click', async () => {
                const count = parseInt(document.querySelector("#buyCount").value);

                if (isNaN(count) || count <= 0) {
                    alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡");
                    return;
                }

                btn.disabled = true;
                btn.innerText = "è™•ç†ä¸­...";

                try {
                    const res = await fetch('http://127.0.0.1:8000/buyProduct', {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            product_id: parseInt(productId),
                            count: count
                        })
                    });
                    const result = await res.json();

                    if (result.sta === 1) {
                        alert("ğŸ‰ è³¼è²·æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„è¨‚è³¼ã€‚");
                        window.location.href = './purchase_record.html'; // å»ºè­°å°å‘è³¼è²·ç´€éŒ„ç¢ºèª
                    } else {
                        alert("è³¼è²·å¤±æ•—ï¼š" + result.message);
                        btn.disabled = false;
                        btn.innerText = "ç¢ºèªè³¼è²·";
                    }
                } catch (error) {
                    alert("ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                    btn.disabled = false;
                    btn.innerText = "ç¢ºèªè³¼è²·";
                }
            });
        }
    </script>
</body>
</html>
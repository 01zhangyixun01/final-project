<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台 - 商品展示系統</title>
    <!-- <link rel="stylesheet" href="/static/style.css"> -->
    
    <style>
        /* 延伸自登入頁面的全域風格 */
        body {
            background: #f4f7f6;
            margin: 0;
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
        }

        /* 導覽列優化 */
        .navbar {
            background-color: #2c3e50;
            padding: 0 20px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .leftnavbar, .rightnavbar {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo {
            font-weight: bold;
            font-size: 20px;
            color: #fff;
            letter-spacing: 1px;
        }
        .navlink {
            color: #bdc3c7;
            text-decoration: none;
            font-size: 15px;
            transition: 0.3s;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .navlink:hover {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }

        /* 主要內容區域與 RWD 網格 */
        .main {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 15px;
            display: grid;
            /* 關鍵：RWD 網格排版 */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        /* 商品卡片美化 */
        .product_box {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            padding-bottom: 15px;
        }
        .product_box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .img_box {
            width: 100%;
            height: 200px;
            object-fit: cover; /* 確保圖片比例不變 */
            background: #eee;
        }

        .name_box {
            font-size: 18px;
            font-weight: bold;
            padding: 15px 15px 5px;
            color: #2c3e50;
        }

        .cost_box {
            font-size: 20px;
            color: #e74c3c;
            font-weight: bold;
            padding: 0 15px;
        }

        .description_text {
            font-size: 14px;
            color: #7f8c8d;
            padding: 10px 15px;
            flex-grow: 1; /* 讓文字撐開空間 */
            line-height: 1.5;
        }

        /* 按鈕美化 */
        .btn_container {
            display: flex;
            padding: 0 15px;
            gap: 10px;
        }
        .update_btn {
            flex: 1;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .update_btn:hover { background: #2980b9; }

        .delete_btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete_btn:hover { background: #c0392b; }

        /* 手機版 RWD 調整 */
        @media (max-width: 600px) {
            .navbar {
                height: auto;
                padding: 10px;
                flex-direction: column;
            }
            .rightnavbar {
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 10px;
            }
            .navlink { font-size: 13px; }
            .main { grid-template-columns: 1fr; } /* 手機上一列一個 */
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="leftnavbar">
            <div class="logo">SUPERMARKET</div>
            
        </div>
        <div class="rightnavbar">
            <a class="navlink" href="/addProduct.html">上架商品</a>
            <a class="navlink" href="/manager_user.html">會員管理</a>
            <a class="navlink" href="/purchase_record.html">購買紀錄</a>
            <a class="navlink out" href="#" style="color: #e74c3c;">登出</a>
        </div>
    </div>
    
    <div class="main" id="productContainer">
        </div>

    <script>
        const container = document.getElementById('productContainer');
        const token = sessionStorage.getItem('token');

        // 初始化：獲取商品清單
        function init() {
            if (!token) {
                alert("請先登入");
                window.location.replace('/');
                return;
            }

            fetch('http://127.0.0.1:8000/getProducts', {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Accept": "application/json"
                }
            })
            .then(res => res.json())
            .then(response => {
                container.innerHTML = ''; // 清空
                response.data.forEach(thing => {
                    // 檢查是否有圖片，沒有則給預設圖
                    const img = thing.image_url || 'https://via.placeholder.com/300x200?text=No+Image';
                    
                    container.innerHTML += `
                    <div class="product_box">
                        <button class="delete_btn" onclick="deleteItem(${thing.id})">✕</button>
                        <img class="img_box" src="${img}" alt="商品圖片">
                        <div class="name_box">${thing.name}</div>
                        <div class="cost_box">$${thing.price}</div>
                        <div class="description_text">${thing.description || '暫無描述'}</div>
                        <div class="btn_container">
                            <button class="update_btn" onclick="goToUpdate(${thing.id})">編輯商品</button>
                        </div>
                    </div>`;
                });
            })
            .catch(err => console.error("Error:", err));
        }

        // 刪除邏輯
        async function deleteItem(productId) {
            if (!confirm("確定要將此商品下架嗎？")) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/deleteProduct/${productId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.sta === 1) {
                    init(); // 重新整理清單
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert("刪除失敗");
            }
        }

        // 登出
        document.querySelector('.out').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm("確定要登出管理系統？")) {
                sessionStorage.removeItem('token');
                window.location.replace('/');
            }
        });

        function goToUpdate(productId) {
            window.location.href = `./updateProduct.html?id=${productId}`;
        }

        // 啟動
        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員管理 - 管理系統</title>
    <!-- <link rel="stylesheet" href="/static/style.css"> -->
    <style>
        body {
            background: #f4f7f6;
            margin: 0;
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
        }

        /* 導覽列 */
        .navbar {
            background-color: #2c3e50;
            padding: 0 20px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .logo { font-weight: bold; color: #fff; text-decoration: none; font-size: 20px; }
        .navlink { color: #bdc3c7; text-decoration: none; font-size: 15px; margin-left: 15px; }

        /* 主容器 */
        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 15px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 { color: #2c3e50; margin: 0; }

        /* RWD 表格容器：關鍵在於外層的 overflow */
        .table-responsive {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow-x: auto; /* 手機版會出現橫向捲軸 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px; /* 確保內容不會縮得太誇張 */
        }

        .main-table th {
            background-color: #f8f9fa;
            color: #34495e;
            font-weight: 600;
            padding: 15px;
            border-bottom: 2px solid #edf2f7;
            text-align: left;
        }

        .main-table td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
            font-size: 15px;
        }

        .main-table tr:hover { background-color: #fcfdfe; }

        /* 標籤設計 (管理員/會員) */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-admin { background: #fee2e2; color: #dc2626; }
        .badge-user { background: #dcfce7; color: #16a34a; }

        /* 刪除按鈕美化 */
        .del_btn {
            background: #fff;
            color: #e53e3e;
            border: 1px solid #e53e3e;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .del_btn:hover {
            background: #e53e3e;
            color: white;
        }

        /* 手機版適配 */
        @media (max-width: 600px) {
            .navbar { padding: 0 10px; }
            .header-section { flex-direction: column; align-items: flex-start; gap: 10px; }
            .container { margin: 20px auto; }
        }
    </style>
</head>
<body>

    <div class="navbar">
        <a href="/manager" class="logo">SUPERMARKET</a>
        <div class="rightnavbar">
            <a href="/manager" class="navlink">返回後台</a>
        </div>
    </div>

    <div class="container">
        <div class="header-section">
            <h2>會員管理系統</h2>
        </div>

        <div class="table-responsive">
            <table class="main-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">ID</th>
                        <th>使用者名稱 (Email)</th>
                        <th>身份等級</th>
                        <th style="width: 100px;">管理操作</th>
                    </tr>
                </thead>
                <tbody id="userList">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const token = sessionStorage.getItem('token_access') || sessionStorage.getItem('token'); 
        const userList = document.querySelector('#userList');

        if (!token) {
            alert("請先登入！");
            window.location.replace('/');
        }

        // 1. 抓取會員清單
        function fetchUsers() {
            fetch('http://127.0.0.1:8000/getCustomers', {
                headers: { "Authorization": `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(response => {
                if (response.sta === 1) {
                    userList.innerHTML = ''; // 清空舊資料
                    response.data.forEach(user => {
                        const levelBadge = user.level === 0 
                            ? '<span class="badge badge-admin">管理員</span>' 
                            : '<span class="badge badge-user">一般會員</span>';
                        
                        userList.innerHTML += `
                            <tr>
                                <td>#${user.id}</td>
                                <td style="font-weight: 500;">${user.name}</td>
                                <td>${levelBadge}</td>
                                <td>
                                    <button class="del_btn" onclick="deleteUser(${user.id})">移除</button>
                                </td>
                            </tr>`;
                    });
                } else {
                    alert("權限不足或 Token 失效");
                }
            })
            .catch(err => console.error("Error:", err));
        }

        // 2. 刪除會員函式
        async function deleteUser(id) {
            if (!confirm("確定要移除這位會員嗎？此動作將導致該使用者無法登入！")) return;

            try {
                const res = await fetch(`http://127.0.0.1:8000/deleteCustomer/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const result = await res.json();
                
                if (result.sta === 1) {
                    alert("已成功移除該會員");
                    fetchUsers(); // 重新整理清單
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert("伺服器連線失敗");
            }
        }

        // 啟動
        fetchUsers();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼è²·ç´€éŒ„ - å•†å“å±•ç¤ºç³»çµ±</title>
    <!-- <link rel="stylesheet" href="/static/style.css"> -->
    <style>
        body {
            background: #f4f7f6;
            margin: 0;
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
        }

        /* å°è¦½åˆ— */
        .navbar {
            background-color: #2c3e50;
            padding: 0 20px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo { font-weight: bold; color: #fff; text-decoration: none; font-size: 20px; }
        .navlink { color: #bdc3c7; text-decoration: none; font-size: 15px; margin-left: 15px; transition: 0.3s; }
        .navlink:hover { color: white; }
        
        button.out {
            background: transparent;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        button.out:hover { background: #e74c3c; color: white; }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 15px;
        }

        h2 { color: #2c3e50; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }

        /* RWD è¡¨æ ¼å®¹å™¨ */
        .table-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto; /* é—œéµï¼šæ‰‹æ©Ÿç‰ˆå¯æ»‘å‹• */
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px; /* ç¢ºä¿å…§å®¹ä¸æ“ å£“ */
        }

        .main-table th {
            background-color: #f8f9fa;
            color: #34495e;
            font-weight: 600;
            padding: 18px 15px;
            text-align: left;
            border-bottom: 2px solid #edf2f7;
        }

        .main-table td {
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            color: #4a5568;
            font-size: 14px;
        }

        /* æ–‘é¦¬ç´‹èˆ‡æ‡¸åœæ•ˆæœ */
        .main-table tr:nth-child(even) { background-color: #fafafa; }
        .main-table tr:hover { background-color: #f1f7ff; }

        /* é‡‘é¡å¼·èª¿ */
        .price-text { color: #e53e3e; font-weight: 600; }
        .count-badge {
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* ç©ºç‹€æ…‹æç¤º */
        .empty-state {
            padding: 50px;
            text-align: center;
            color: #a0aec0;
        }

        /* RWD æ‰‹æ©Ÿèª¿æ•´ */
        @media (max-width: 600px) {
            .container { margin: 20px auto; }
            h2 { font-size: 20px; }
            .navbar { padding: 0 10px; }
            .logo { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="leftnavbar">
            <a href="#" id="homeLink" class="logo">SUPERMARKET</a>
            <a href="#" id="homeSubLink" class="navlink">é¦–é </a>
        </div>
        <div class="rightnavbar">
            <button class="out" id="logoutBtn">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š è³¼è²·ç´€éŒ„æŸ¥è©¢</h2>

        <div class="table-card">
            <div class="table-responsive">
                <table class="main-table" id="recordTable">
                    <thead>
                        <tr id="tableHeader">
                            </tr>
                    </thead>
                    <tbody id="recordBody">
                        <tr>
                            <td colspan="6" class="empty-state">è³‡æ–™è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const recordBody = document.querySelector('#recordBody');
        const tableHeader = document.querySelector('#tableHeader');
        const token = sessionStorage.getItem('token');
        const homeLink = document.querySelector('#homeLink');
        const homeSubLink = document.querySelector('#homeSubLink');

        if (!token) {
            window.location.replace('/');
        } else {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const dest = (payload.level === 0) ? "./manager" : "./home";
                homeLink.href = dest;
                homeSubLink.href = dest;
            } catch (e) {
                console.error("Token è§£æå¤±æ•—");
            }
        }

        const formatTime = (ts) => new Date(ts * 1000).toLocaleString('zh-TW', { hour12: false });

        fetch('http://127.0.0.1:8000/getPurchaseHistory', {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(response => {
            const level = response.level; // 0 æ˜¯ç®¡ç†å“¡
            const allData = response.data;

            // 1. ç”Ÿæˆè¡¨é ­
            tableHeader.innerHTML = `
                ${level === 0 ? '<th>è³¼è²·å¸³è™Ÿ</th>' : ''}
                <th>å•†å“åç¨±</th>
                <th>å–®åƒ¹</th>
                <th>æ•¸é‡</th>
                <th>ç¸½è¨ˆé‡‘é¡</th>
                <th>äº¤æ˜“æ™‚é–“</th>
            `;

            // 2. æ¸²æŸ“è³‡æ–™
            if (!allData || allData.length === 0) {
                recordBody.innerHTML = `<tr><td colspan="6" class="empty-state">ç›®å‰å°šç„¡ä»»ä½•äº¤æ˜“ç´€éŒ„</td></tr>`;
            } else {
                let html = '';
                allData.forEach(ele => {
                    const totalPrice = ele.price * ele.count;
                    html += `
                        <tr>
                            ${level === 0 ? `<td style="font-weight:500">${ele.user_name}</td>` : ''}
                            <td>${ele.product}</td>
                            <td>$${ele.price}</td>
                            <td><span class="count-badge">${ele.count}</span></td>
                            <td><span class="price-text">$${totalPrice}</span></td>
                            <td style="color:#718096">${formatTime(ele.time)}</td>
                        </tr>`;
                });
                recordBody.innerHTML = html;
            }
        })
        .catch(err => {
            recordBody.innerHTML = `<tr><td colspan="6" class="empty-state" style="color:#e53e3e">é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥</td></tr>`;
        });

        document.querySelector('#logoutBtn').addEventListener('click', () => {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                sessionStorage.removeItem('token');
                window.location.replace('/');
            }
        });
    </script>
</body>
</html>